import hashlib
import logging
import os
import json
from datetime import datetime
from functools import wraps

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    filename='bank.log',
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
    # encoding='utf-8' # –£–±—Ä–∞–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Python 3.8
)

# –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
ACCOUNTS_FILE = "accounts.txt"


def load_accounts():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —É—á–µ—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ñ–∞–π–ª–∞."""
    if not os.path.exists(ACCOUNTS_FILE):
        return {}
    with open(ACCOUNTS_FILE, 'r', encoding='utf-8') as f:
        try:
            return json.load(f)
        except json.JSONDecodeError:
            return {}


def save_accounts(accounts):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —É—á–µ—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª."""
    with open(ACCOUNTS_FILE, 'w', encoding='utf-8') as f:
        json.dump(accounts, f, indent=4, ensure_ascii=False)


def hash_password(password):
    """–•–µ—à–∏—Ä—É–µ—Ç –ø–∞—Ä–æ–ª—å —Å –ø–æ–º–æ—â—å—é SHA-256."""
    return hashlib.sha256(password.encode()).hexdigest()


def validate_amount(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—É–º–º—ã –æ–ø–µ—Ä–∞—Ü–∏–∏."""
    @wraps(func)
    def wrapper(self, amount, *args, **kwargs):
        if not isinstance(amount, (int, float)) or amount <= 0:
            raise ValueError("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
        return func(self, amount, *args, **kwargs)
    return wrapper


def validate_pin(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∏–Ω-–∫–æ–¥–∞ –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏–µ–π."""
    @wraps(func)
    def wrapper(self, *args, **kwargs):
        if self.is_frozen:
            raise PermissionError("–°—á—ë—Ç –∑–∞–º–æ—Ä–æ–∂–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.")
        if not self._check_pin():
            raise PermissionError("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∏–Ω-–∫–æ–¥. –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.")
        return func(self, *args, **kwargs)
    return wrapper


class BankAccount:
    def __init__(self, user_id, name, pin, balance=0.0):
        self.user_id = user_id
        self.name = name
        self._pin = hash_password(pin)
        self.balance = balance
        self.is_frozen = False
        self._failed_attempts = 0

    def _check_pin(self, pin_input=None):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∏–Ω-–∫–æ–¥. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –ø—Ä–∏ —É—Å–ø–µ—Ö–µ."""
        if self.is_frozen:
            return False

        if pin_input is None:
            pin_input = input("–í–≤–µ–¥–∏—Ç–µ –ø–∏–Ω-–∫–æ–¥: ")

        if hash_password(pin_input) == self._pin:
            self._failed_attempts = 0  # —Å–±—Ä–æ—Å –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ
            return True
        else:
            self._failed_attempts += 1
            if self._failed_attempts >= 3:
                self._freeze_account()
            return False

    def _freeze_account(self):
        """–ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç —Å—á—ë—Ç –∏ –º–µ–Ω—è–µ—Ç –ø–∏–Ω –Ω–∞ '0000'."""
        self.is_frozen = True
        self._pin = hash_password("0000")
        logging.warning(f"–°—á—ë—Ç {self.user_id} –∑–∞–º–æ—Ä–æ–∂–µ–Ω –ø–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫.")
        print("‚ö†Ô∏è –°—á—ë—Ç –∑–∞–º–æ—Ä–æ–∂–µ–Ω –∏–∑-–∑–∞ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã—Ö –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞. –ù–æ–≤—ã–π –ø–∏–Ω: 0000")

    @validate_amount
    @validate_pin
    def deposit(self, amount):
        """–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á—ë—Ç–∞."""
        self.balance += amount
        message = f"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á—ë—Ç–∞ {self.user_id} –Ω–∞ {amount:.2f}. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {self.balance:.2f}"
        logging.info(message)
        print(message)

    @validate_amount
    @validate_pin
    def withdraw(self, amount):
        """–°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤."""
        if amount > self.balance:
            raise ValueError("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á—ë—Ç–µ.")
        self.balance -= amount
        message = f"–°–Ω—è—Ç–∏–µ —Å —Å—á—ë—Ç–∞ {self.user_id} —Å—É–º–º—ã {amount:.2f}. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {self.balance:.2f}"
        logging.info(message)
        print(message)

    @validate_amount
    @validate_pin
    def transfer(self, amount, recipient):
        """–ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –¥—Ä—É–≥–æ–π —Å—á—ë—Ç."""
        if not isinstance(recipient, BankAccount):
            raise TypeError("–ü–æ–ª—É—á–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º BankAccount.")
        if amount > self.balance:
            raise ValueError("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞.")
        self.balance -= amount
        recipient.balance += amount
        message = (f"–ü–µ—Ä–µ–≤–æ–¥ —Å {self.user_id} –Ω–∞ {recipient.user_id} —Å—É–º–º—ã {amount:.2f}. "
                   f"–ë–∞–ª–∞–Ω—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: {self.balance:.2f}, –ø–æ–ª—É—á–∞—Ç–µ–ª—è: {recipient.balance:.2f}")
        logging.info(message)
        print(message)

    def to_dict(self):
        """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –æ–±—ä–µ–∫—Ç –≤ —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."""
        return {
            "user_id": self.user_id,
            "name": self.name,
            "pin_hash": self._pin,
            "balance": self.balance,
            "is_frozen": self.is_frozen
        }

    @classmethod
    def from_dict(cls, data):
        """–°–æ–∑–¥–∞—ë—Ç –æ–±—ä–µ–∫—Ç –∏–∑ —Å–ª–æ–≤–∞—Ä—è."""
        account = cls.__new__(cls)
        account.user_id = data["user_id"]
        account.name = data["name"]
        account._pin = data["pin_hash"]
        account.balance = data["balance"]
        account.is_frozen = data["is_frozen"]
        account._failed_attempts = 0
        return account


class Bank:
    def __init__(self):
        self.accounts = {}
        self._load_accounts_from_file()

    def _load_accounts_from_file(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Å—á–µ—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞."""
        raw_data = load_accounts()
        for user_id, data in raw_data.items():
            self.accounts[user_id] = BankAccount.from_dict(data)

    def _save_all_accounts(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Å—á–µ—Ç–∞ –≤ —Ñ–∞–π–ª."""
        data = {uid: acc.to_dict() for uid, acc in self.accounts.items()}
        save_accounts(data)

    def create_account(self):
        """–°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Å—á—ë—Ç."""
        user_id = input("–í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ").strip()
        if user_id in self.accounts:
            print("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º ID —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
            return

        name = input("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å—á—ë—Ç–∞: ").strip()
        if not name:  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–µ –∏–º—è
            print("‚ùå –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.")
            return

        pin = input("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –ø–∏–Ω-–∫–æ–¥: ").strip()
        if len(pin) != 4 or not pin.isdigit():
            print("‚ùå –ü–∏–Ω-–∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 4 —Ü–∏—Ñ—Ä—ã.")
            return

        account = BankAccount(user_id, name, pin)
        self.accounts[user_id] = account
        self._save_all_accounts()
        logging.info(f"–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Å—á—ë—Ç: {user_id} ({name})")
        print(f"‚úÖ –°—á—ë—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –¥–ª—è {name} (ID: {user_id})")

    def login(self):
        """–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É –ø–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        user_id = input("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID: ").strip()
        if user_id not in self.accounts:
            print("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return None
        return self.accounts[user_id]

    def run(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–∞–Ω–∫–∞."""
        while True:
            print("\nüè¶ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫")
            print("1. –°–æ–∑–¥–∞—Ç—å —Å—á—ë—Ç")
            print("2. –í–æ–π—Ç–∏ –≤ —Å—á—ë—Ç")
            print("3. –í—ã–π—Ç–∏")
            choice = input("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: ").strip()

            if choice == "1":
                self.create_account()
            elif choice == "2":
                account = self.login()
                if account:
                    self._account_menu(account)
            elif choice == "3":
                print("üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                break
            else:
                print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.")

    def _account_menu(self, account):
        """–ú–µ–Ω—é –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—á—ë—Ç–æ–º."""
        while True:
            print(f"\nüë§ –°—á—ë—Ç: {account.name} (ID: {account.user_id})")
            print(f"üí∞ –ë–∞–ª–∞–Ω—Å: {account.balance:.2f}")
            if account.is_frozen:
                print("üîí –°—á—ë—Ç –∑–∞–º–æ—Ä–æ–∂–µ–Ω!")
            print("1. –ü–æ–ø–æ–ª–Ω–∏—Ç—å")
            print("2. –°–Ω—è—Ç—å")
            print("3. –ü–µ—Ä–µ–≤–µ—Å—Ç–∏")
            print("4. –ù–∞–∑–∞–¥")
            choice = input("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: ").strip()

            try:
                if choice == "1":
                    amount = float(input("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: "))
                    account.deposit(amount)
                    self._save_all_accounts()
                elif choice == "2":
                    amount = float(input("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å–Ω—è—Ç–∏—è: "))
                    account.withdraw(amount)
                    self._save_all_accounts()
                elif choice == "3":
                    recipient_id = input("ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è: ").strip()
                    if recipient_id not in self.accounts:
                        print("‚ùå –ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                        continue
                    recipient = self.accounts[recipient_id]
                    if recipient == account:
                        print("‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–∞–º–æ–º—É —Å–µ–±–µ.")
                        continue
                    amount = float(input("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–µ—Ä–µ–≤–æ–¥–∞: "))
                    account.transfer(amount, recipient)
                    self._save_all_accounts()
                elif choice == "4":
                    break
                else:
                    print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.")
            except ValueError as e:
                print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            except PermissionError as e:
                print(f"üîí {e}")
            except TypeError as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–∏–ø–∞: {e}")


if __name__ == "__main__":
    bank = Bank()
    bank.run()

if __name__ == "__main__":
    bank = Bank()
    bank.run()
